name: Build and publish application

on:
  push:
    tags:
      - '*'  # trigger on any new tag

jobs:
  build-publish:
    name: Build, Push, Release
    runs-on: ubuntu-latest
    environment: docker

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push images
        run: |
          docker build ./todo-app/todo-app-web-server -t wilky2/todoappwebserver:${GITHUB_SHA}
          docker push wilky2/todoappwebserver:${GITHUB_SHA}
          docker build ./todo-app/todo-backend -t wilky2/todobackend:${GITHUB_SHA}
          docker push wilky2/todobackend:${GITHUB_SHA}
          docker build ./todo-app/broadcast -t wilky2/broadcast:${GITHUB_SHA}
          docker push wilky2/broadcast:${GITHUB_SHA}

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Update Kustomization Images
        run: |
          cd todo-app/config/overlays/prod
          kustomize edit set image FRONTEND/IMAGE=wilky2/todoappwebserver:${GITHUB_SHA} BACKEND/IMAGE=wilky2/todobackend:${GITHUB_SHA} BROADCAST/IMAGE=wilky2/broadcast:${GITHUB_SHA}

      - name: Switch to master
        run: git checkout master

      - name: Commit kustomization.yaml
        uses: EndBug/add-and-commit@v9
        with:
          add: './todo-app/config/overlays/prod/kustomization.yaml'
          message: "Update prod images for release ${{ github.ref_name }}"
          push: true

      - name: Update Git tags
        run: |
          git tag -f ${{ github.ref_name }}  # move current release tag to new commit
          git tag -f prod                    # move prod tag to same commit
          git push origin --tags -f
