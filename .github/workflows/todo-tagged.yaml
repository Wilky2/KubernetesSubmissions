name: Build, Publish and Update Production

on:
  push:
    tags:
      - '*'  # trigger on any new tag

jobs:
  build-publish:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repository with full history
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️⃣ Log in to Docker Hub
      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 3️⃣ Build and push Docker images with SHA tag
      - name: Build and push images
        run: |
          docker build ./todo-app/todo-app-web-server -t wilky2/todoappwebserver:${GITHUB_SHA}
          docker push wilky2/todoappwebserver:${GITHUB_SHA}
          docker build ./todo-app/todo-backend -t wilky2/todobackend:${GITHUB_SHA}
          docker push wilky2/todobackend:${GITHUB_SHA}
          docker build ./todo-app/broadcast -t wilky2/broadcast:${GITHUB_SHA}
          docker push wilky2/broadcast:${GITHUB_SHA}

      # 4️⃣ Set up Kustomize
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      # 5️⃣ Update kustomization.yaml with new images
      - name: Update Kustomization Images
        run: |
          cd todo-app/config/overlays/prod
          kustomize edit set image FRONTEND/IMAGE=wilky2/todoappwebserver:${GITHUB_SHA} BACKEND/IMAGE=wilky2/todobackend:${GITHUB_SHA} BROADCAST/IMAGE=wilky2/broadcast:${GITHUB_SHA}

      # 6️⃣ Switch to master branch
      - name: Switch to master
        run: git checkout master

      # 7️⃣ Commit the updated kustomization.yaml
      - name: Commit kustomization.yaml
        uses: EndBug/add-and-commit@v9
        with:
          add: './todo-app/config/overlays/prod/kustomization.yaml'
          message: "Update prod images for release ${{ github.ref_name }}"
          push: true

      # 8️⃣ Update the current tag and move the 'prod' tag to point to master
      - name: Update Git tags
        run: |
          git tag -f ${{ github.ref_name }}  # move current release tag to new commit
          git tag -f prod                    # move prod tag to same commit
          git push origin --tags -f
