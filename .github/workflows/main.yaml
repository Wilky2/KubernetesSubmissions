name: Release application

on:
  push:

env:
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  GKE_CLUSTER: dwk-cluster
  GKE_ZONE: europe-north1-b
  REGISTRY: europe-north1-docker.pkg.dev
  REPOSITORY: wilky
  FRONTEND-IMAGE: todoappwebserver
  BACkEND-IMAGE: todobackend
  SERVICE: dwk-environments
  BRANCH: ${{ github.ref_name }}

# ...
jobs:
  build-publish-deploy:
    name: Build, Publish and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

# ...
  - uses: google-github-actions/auth@v2
    with:
      credentials_json: '${{ secrets.GKE_SA_KEY }}'

  - name: 'Set up Cloud SDK'
    uses: google-github-actions/setup-gcloud@v2

  - name: 'Use gcloud CLI'
    run: gcloud info

# ...
  - run: gcloud --quiet auth configure-docker

# ...
  - name: 'Get GKE credentials'
    uses: 'google-github-actions/get-gke-credentials@v2'
    with:
      cluster_name: '${{ env.GKE_CLUSTER }}'
      project_id: '${{ env.PROJECT_ID }}'
      location: '${{ env.GKE_ZONE }}'

# ...
  - name : 'Form the frontend image name'
    run: echo "FRONTEND_IMAGE_TAG=$REGISTRY/$PROJECT_ID/$REPOSITORY/$FRONTEND-IMAGE:$BRANCH-$GITHUB_SHA" >> $GITHUB_ENV

# ...
  - name: Build
    run: docker build todo-app/todo-app-web-server --tag $FRONTEND_IMAGE_TAG

  - name: Publish
    run: docker push $FRONTEND_IMAGE_TAG

# ...
  - name : 'Form the backend image name'
    run: echo "BACkEND_IMAGE_TAG=$REGISTRY/$PROJECT_ID/$REPOSITORY/$BACkEND-IMAGE:$BRANCH-$GITHUB_SHA" >> $GITHUB_ENV

# ...
  - name: Build
    run: docker build todo-app/todo-backend --tag $BACkEND_IMAGE_TAG

  - name: Publish
    run: docker push $BACkEND_IMAGE_TAG

# ...
  - name: Set up Kustomize
    uses: imranismail/setup-kustomize@v2.1.0

# ...
  - name: Deploy
    run: |-
      kustomize edit set image FRONTEND/IMAGE=$FRONTEND_IMAGE_TAG
      kustomize edit set image BACKEND/IMAGE=$BACkEND_IMAGE_TAG
      kustomize build . | kubectl apply -f -
      kubectl rollout status deployment $SERVICE
      kubectl get services -o wide